# spec: cspell-dict-add

## 概要

VS Code 拡張機能 cspell（Code Spell Checker）の「辞書にない単語」を、ユーザーが使っているカスタム辞書ファイルに一括登録しやすくするための補助アプリケーション（VS Code 拡張機能）とします。

- VS Code の PROBLEMS タブに表示されている cspell のスペルチェック結果を取得し、辞書に未登録の単語一覧を表示します。
- ユーザーは一覧から登録したい単語だけを選択して、まとめてユーザー辞書ファイルへ追記できます。

## 前提条件

- thisis atest youyou pepepe
- ユーザーの VS Code に cspell 拡張機能がインストールされ、有効になっていること。
- スペルチェック対象のファイルが開かれている、またはワークスペース全体に対して cspell が実行済みであり、PROBLEMS タブに cspell の診断メッセージが存在していること。
- 辞書は VS Code の `settings.json` で次のように設定されているものとします。

  ```jsonc
  "cSpell.customDictionaries": {
    "custom-dictionary-user": {
      "addWords": true,
      "name": "custom-dictionary-user",
      "path": "~/.vscode/cspell/custom-dictionary-user.txt",
      "scope": "user"
    }
  }
  ```

* 本アプリは、上記のように `addWords: true` かつ `path` が指定されているカスタム辞書を「登録先辞書」として扱います。
* `~` を含むパスは、OS のユーザーディレクトリに展開して使用します。

## ユースケース

1. ユーザーが VS Code でソースコードや文章ファイルを編集します。
2. cspell により PROBLEMS タブにスペルミスや未知の単語が表示されます。
3. ユーザーがコマンドパレットから `CSpell Dict Add: Open`（仮称）を実行します。
4. 本アプリが cspell の診断から「辞書に未登録の単語」を抽出し、シンプルな UI に一覧表示します。
5. ユーザーは一覧のチェックボックスを操作して、登録したい単語だけを選択します（デフォルトでは全選択）。
6. ユーザーが「登録」操作を行うと、選択された単語がまとめて辞書ファイルに追記されます。

## 対象とする問題（PROBLEMS）

- VS Code API（例: `vscode.languages.getDiagnostics()`）から取得できる診断情報を対象とします。
- 診断のうち、`source` が `cSpell`（またはそれに相当する値）であるものだけを対象とします。
- 診断メッセージまたは関連情報から「未知の単語」となる文字列を抽出します。
- 同じ単語が複数箇所で報告されている場合は、一覧上では 1 行に集約し、出現回数を付加して表示します。

## アプリ動作仕様

### コマンド

- コマンド名（例）

  - `cspell-dict-add.open`

- 呼び出し方法

  - コマンドパレット
  - キーボードショートカット（ユーザー任意）

### 起動時の処理フロー

1. 現在のワークスペースまたは開いているファイルの診断情報を取得します。
2. cspell 由来の診断だけをフィルタリングします。
3. 診断から未知の単語一覧を抽出します。
4. 辞書ファイル（例: `~/.vscode/cspell/custom-dictionary-user.txt`）を読み込み、既に登録されている単語を取得します。
5. 既登録の単語は一覧から除外し、重複も排除した単語一覧を作成します。
6. 抽出した「未登録の単語」が 0 件の場合は、通知を表示して処理を終了します。

   - 例: 「cspell で新しく登録する単語は見つかりませんでした。」

## UI 仕様（シンプル UI）

UI は VS Code 標準の QuickPick などを用いたシンプルなものとし、Webview などのリッチ UI は使用しません。

### 一覧表示

- 表示内容（1 行 1 単語）:

  - チェックボックス（QuickPick の `canPickMany` を想定。デフォルトでオン）
  - ラベル: 単語文字列
  - 説明: 出現回数（例: `appears 12 times`）

- デフォルト状態ではすべての単語が選択済み（登録対象）です。
- ユーザーはチェックを外すことで「今回登録しない単語」を選択できます。

### 操作フロー

1. QuickPick で一覧を表示し、ユーザーがチェック状態を編集します。
2. ユーザーが「確定」（Enter）したタイミングで選択された単語一覧を取得します。
3. 選択された単語が 0 件の場合は、「登録する単語が選択されていません」と通知して処理を終了します。

## 辞書ファイルの更新仕様

- 辞書ファイルパス

  - VS Code 設定 `cSpell.customDictionaries` の中から、`addWords: true` かつ `path` を持つエントリを取得します。
  - 基本ケースとして、`custom-dictionary-user` を用います。
  - 複数存在する場合は、最初のエントリを使用するか、今後の拡張として選択可能にすることを想定します（現行仕様では「最初のエントリ」を使用でも可とします）。

- パス解決

  - `~` を OS のホームディレクトリに展開します。
  - 相対パスの場合はワークスペースルートまたは設定ファイル基準など、VS Code 標準に準拠した解決方法を採用します。

- 読み込み

  - 行単位で単語を読み込み、空行・コメント行（先頭が `#` など）は無視します（コメント扱い）。

- 書き込み

  - 新規追加する単語のみを末尾に追記します。
  - 一行一単語とし、すでに存在する単語は追記しません（重複防止）。
  - 文字コードは既存ファイルに合わせます（UTF-8 を想定）。

### 登録処理フロー

1. 選択された単語一覧を取得します。
2. 辞書ファイルを読み込み、既存単語の集合を作成します。
3. 既存にない単語だけを抽出します。
4. 抽出された単語を辞書ファイル末尾に追記します。
5. 追加件数をカウントし、通知を表示します。

   - 例: 「3 件の単語を `custom-dictionary-user.txt` に登録しました。」

6. 必要に応じて PROBLEMS を再取得し、cspell の診断が減っていることを確認するのはユーザーに任せます（自動リフレッシュは必須とはしません）。

## 設定項目（VS Code 設定・拡張設定）

本アプリ固有の設定は最小限とし、以下のみを想定します。

- `cspellDictAdd.dictionaryKey`

  - 説明: `cSpell.customDictionaries` 内のどのキーを「登録先辞書」として使用するかを指定します。
  - 型: string
  - デフォルト: `"custom-dictionary-user"`
  - 例: `"team-dictionary"` など、別のカスタム辞書に切り替えたい場合に使用します。

- `cspellDictAdd.minOccurrence`

  - 説明: 一覧に表示するために必要な最小出現回数。
  - 型: number
  - デフォルト: `1`
  - 例: `2` に設定した場合、ワークスペース内で 2 回以上出てくる単語だけを一覧に表示します。

## エラー処理

- PROBLEMS から診断情報が取得できなかった場合

  - メッセージ例: 「cspell の診断情報を取得できませんでした。cspell が有効かどうか確認してください。」

- `cSpell.customDictionaries` に有効な辞書設定が見つからない場合

  - メッセージ例: 「cSpell のカスタム辞書設定が見つかりませんでした。`cSpell.customDictionaries` を確認してください。」

- 辞書ファイルの読み込みに失敗した場合

  - メッセージ例: 「辞書ファイルを読み込めませんでした。パスや権限を確認してください。」

- 辞書ファイルの書き込みに失敗した場合

  - メッセージ例: 「辞書ファイルへの書き込みに失敗しました。ファイルの書き込み権限やロック状態を確認してください。」

- 一部の単語だけが失敗した場合

  - 成功件数と失敗件数を通知メッセージに含めます。

## 非機能要件

- 未登録単語数が 100〜200 語程度の規模であっても、ユーザーが体感的にストレスを感じない速度で処理が完了することを目標とします。
- 処理は可能な範囲で非同期に行い、VS Code の UI をブロックしないようにします。
- UI はキーボードのみで完結して操作できることを目指します。

## 実装言語

- VS Code 拡張機能として実装することを前提とし、TypeScript または JavaScript を使用して実装します。
- 内部実装言語には依存しない仕様とします。

```

```
